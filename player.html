<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Org Game Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/jsog@1.0.7/lib/JSOG.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div class="terminal">
        <div class="terminal-line">Social Realization Module</div>
        <input type="text" id="apiKey" placeholder="Enter API Key">
        <button id="loginBtn">Log In</button>
        <br>
        <br>
        <input type="text" id="playerName" placeholder="Enter Name">
        <button id="registerBtn">Register</button>
        <div class="cursor"></div>
    </div>
    <div id="message" class="hidden"></div>
    <div id="error" class="hidden"></div>

    <div id="orgList" class="hidden">
    </div>

    <div id="orgDetailView" class="hidden">
        <h2 id="orgDetailName"></h2>
        <div id="orgDetailInfo"></div>
        <div id="currentPhaseActions">
          <div class="phase-goalExpression">
            <div id="proposeGoal">
                <h3>Propose Goal</h3>
                <input type="text" id="goalDescription" placeholder="Goal Description">
                <button id="proposeGoalBtn">Propose Goal</button>            
            </div>
          </div>
          <div class="phase-goalAllocation">
            <div id="allocateToGoal">
                <h3>Allocate to Goal</h3>
                <input type="number" id="amountAllocateGoal" placeholder="Amount">
                <input type="text" id="goalIdAllocate" placeholder="Goal ID">
                <button id="allocateToGoalBtn">Allocate to Goal</button>
            </div>
          </div>
          <div class="phase-offerExpression">
            <div id="makeOffer">
                <h3>Make Offer</h3>
                <input type="text" id="offerName" placeholder="Offer Name">
                <input type="text" id="offerDescription" placeholder="Offer Description">
                <input type="text" id="offerEffects" placeholder="Offer Effects">
                <input type="number" id="offerAsk" placeholder="Ask Amount">
                <input type="text" id="targetGoalIds" placeholder="Target Goal IDs (comma-separated)">
                <button id="makeOfferBtn">Make Offer</button>
            </div>
          </div>
          <div class="phase-offerAllocation">
            <div id="allocateToOffer">
                <h3>Allocate to Offer</h3>
                <input type="number" id="amountAllocateOffer" placeholder="Amount">
                <input type="text" id="fromGoalId" placeholder="From Goal ID">
                <input type="text" id="toOfferId" placeholder="To Offer ID">
                <button id="allocateToOfferBtn">Allocate to Offer</button>
            </div>
            <div id="acceptCounterOffer">
                <h3>Respond to Counter Offer</h3>
                <input type="text" id="counterOfferId" placeholder="Counter Offer ID">
                <select id="acceptCounterOfferDecision">
                    <option value="true">Accept</option>
                    <option value="false">Reject</option>
                </select>
                <button id="acceptCounterOfferBtn">Submit Decision</button>
            </div>
          </div>
          <div class="phase-completions">
            <div id="claimCompletion">
                <h3>Claim Completion</h3>
                <input type="text" id="offerIdClaim" placeholder="Offer ID">
                <input type="text" id="claimDescription" placeholder="Claim Description">
                <button id="claimCompletionBtn">Claim Completion</button>
            </div>
            <div id="challengeCompletion">
                <h3>Challenge Completion</h3>
                <input type="text" id="completionIdChallenge" placeholder="Completion ID">
                <input type="text" id="challengeDescription" placeholder="Challenge Description">
                <button id="challengeCompletionBtn">Challenge Completion</button>
            </div>
            <div id="supportChallenge">
                <h3>Support Challenge</h3>
                <input type="text" id="completionIdSupport" placeholder="Completion ID">
                <select id="supportDecision">
                    <option value="true">Support</option>
                    <option value="false">Oppose</option>
                </select>
                <button id="supportChallengeBtn">Submit Support</button>
            </div>
          </div>
        </div>
      </div>

    <div id="playerCards" class="card-container">
        <!-- Player cards will be dynamically inserted here -->
      </div>
      
      <div id="goalCards" class="card-container">
        <!-- Goal cards will be dynamically inserted here -->
      </div>

    <div id="leaderboards" class="section hidden">
        <h2>Get Leaderboards</h2>
        <button id="goalLeaderboardBtn">Goal Leaderboard</button>
        <button id="offerLeaderboardBtn">Offer Leaderboard</button>
        <select id="leaderboardDimension">
            <option value="potentialValue">Potential Value</option>
            <option value="realizedValue">Realized Value</option>
        </select>
        <button id="getLeaderboardBtn">Get Leaderboard</button>
        <div id="leaderboardResult"></div>
    </div>

    <script>

        let apiKey = '';
        let playerId = '';
        let currentPhase = '';
        let currentOrgId = '';

        async function playerAction(actionType, actionParams) {
            try {
                const response = await $.post('http://localhost:3000/player-action', {
                    apiKey: apiKey,
                    actionType: actionType,
                    actionParams: actionParams
                });
                if (response.success) {
                    setMessage(actionType + ' successful');
                    return JSOG.decode(response.result);
                } else {
                    showError(actionType + ' failed: ' + response.error);
                }
            } catch (error) {
                showError('Request failed: ' + error.message);
            }
        }

        async function joinOrganization(org) {
        await playerAction('joinOrg', [org.id], function(data) {
            if (data.success) {
                fetchOrgRegistry(); // Refresh the org list
                displayPlayerCards(org);
                displayGoalCards(org);
            }
    });
}

        function showError(error) {
            $('#error').removeClass('hidden')
            $('#error').text(error).show().fadeOut(5000);
            $('#error').addClass('hidden')
        }

        function setMessage(message) {
            $('#message').removeClass('hidden')
            $('#message').text(message).show().fadeOut(5000);
            $('#error').addClass('hidden')
        }

    function updateVisibility() {
            $('.phase-' + currentPhase).show();
            $('.phase-' + currentPhase).siblings().hide();
            $('.always-visible').show();
        }

    function fetchOrgRegistry() {
                $.get('http://localhost:3000/get-org-registry', function(data) {
                    if (data.success) {
                        displayOrgList(JSOG.decode(data.registryData));
                    } else {
                        showError('Fetched registryData failed: ' + data.error);
                    }
            });
    }

function displayOrgList(orgs) {
    const orgList = $('#orgList');
    $('#orgList').removeClass('hidden');
    orgList.empty();
    console.log('ORGS', orgs)

    const sortedOrgs = orgs.sort((a, b) => {
        if (a.id === playerId && b.id !== playerId) return -1;
        if (a.id !== playerId && b.id === playerId) return 1;

        const aIncludesPlayer = a.players.hasOwnProperty(playerId);
        const bIncludesPlayer = b.players.hasOwnProperty(playerId);

        if (aIncludesPlayer && !bIncludesPlayer) return -1;
        if (!aIncludesPlayer && bIncludesPlayer) return 1;

        return 0;
    });

    sortedOrgs.forEach((org, index) => {
        const orgCard = $('<div>').addClass('org-card');
        
        if (org.id === playerId || (index === 0 && org.players.hasOwnProperty(playerId))) {
            orgCard.addClass('current-player');
        }

        orgCard.append($('<h3>').addClass('org-name').text(org.name));
        orgCard.append($('<p>').text('ID: ' + org.id));
        orgCard.append($('<p>').text('Phase: ' + org.currentPhase));

        console.log('org', org.players)
        console.log('playerID', playerId)

        if(!org.players.hasOwnProperty(playerId)) {
            const joinButton = $('<button>').text('Join').click(function() {
                currentOrgId = org.id
                joinOrganization(org)
                console.log('PLAYERID', playerId)
                org.players[playerId] = {}
                updatePhaseActions(org, playerId, org.currentPhase)
                joinButton.hide()
            });
            orgCard.append(joinButton);
        }

        const detailButton = $('<button>').text('Details').click(function() {
    currentOrgId = org.id
    $('#orgDetailName').text(org.name);
    const detailInfo = $('#orgDetailInfo');
    detailInfo.empty();
    detailInfo.append($('<p>').html('<strong>ID:</strong> ' + org.id));
    detailInfo.append($('<p>').html('<strong>Current Cycle:</strong> ' + org.currentCycle));

    const phaseP = $('<p>').html('<strong>Current Phase:</strong> ' + org.currentPhase);
    if (currentOrgId === playerId) {
        const shiftButton = $('<button>').text('Shift Phase').click(async function() {
            await playerAction('runPhaseShift', [org.id]);
            fetchOrgRegistry()
            displayOrgList(sortedOrgs)
        });
        phaseP.append(' ').append(shiftButton);
    }
    detailInfo.append(phaseP);

    const potentialValueP = $('<p>').html('<strong>Potential Value:</strong> ' + org.potentialValue);
    if (currentOrgId === playerId) {
        const potentialValueInput = $('<input>').attr({type: 'number', placeholder: 'Amount'});
        const issuePotentialButton = $('<button>').text('Issue Potential').click(async function() {
            await playerAction('issuePotential', [playerId, parseInt(potentialValueInput.val())]);
            fetchOrgRegistry()
            displayOrgList(sortedOrgs)     
        });
        potentialValueP.append(' ').append(potentialValueInput).append(issuePotentialButton);
    }
    detailInfo.append(potentialValueP);

    const sharesP = $('<p>').html('<strong>Shares:</strong> ' + org.shares);
    if (currentOrgId === playerId) {
        const sharesInput = $('<input>').attr({type: 'number', placeholder: 'Amount'});
        const issueSharesButton = $('<button>').text('Issue Shares').click(async function() {
            await playerAction('issueShares', [org.id, parseInt(sharesInput.val())]);
            fetchOrgRegistry()
            displayOrgList(sortedOrgs)
        });
        sharesP.append(' ').append(sharesInput).append(issueSharesButton);
    }
    detailInfo.append(sharesP);

    detailInfo.append($('<p>').html('<strong>Realized Value:</strong> ' + org.realizedValue));

    const playerCardsContainer = document.getElementById('playerCards');
    playerCardsContainer.innerHTML = '';

    const goalCardsContainer = document.getElementById('goalCards');
    goalCardsContainer.innerHTML = '';
    
    if(Object.keys(org.players).length > 0) {
        console.log(org.players)
        displayPlayerCards(org);
    }

    if(Object.keys(org.goals).length > 0) {
        displayGoalCards(org);
    }

    if(['offerExpression', 'offerAllocation', 'completions'].includes(org.currentPhase)) {
        displayListItems(detailInfo, 'Offers', org.offers);
    }

    updatePhaseActions(org, playerId, org.currentPhase)

    $('#orgDetailView').removeClass('hidden');
});
        orgCard.append(detailButton);

        orgList.append(orgCard);
    });
}


async function displayPlayerCards(org) {
    const playerCardsContainer = document.getElementById('playerCards');
    playerCardsContainer.innerHTML = '';
    for (const playerId in org.players) {
        player = await playerAction('getOrg', [playerId]);
        console.log('PLAYER DATA', player)
        console.log('OROGOGOG', org)
        const cycleSpecificOrgData = player.orgData[org.id][org.currentCycle];
        if (player) {
            const card = document.createElement('div');
            card.className = 'card player-card';
            card.innerHTML = `
                <h3>${player.name || 'Unknown Player'}</h3>
                <p>ID: ${playerId}</p>
                <p>Shares: ${cycleSpecificOrgData.shares || 0}</p>
            `;
            playerCardsContainer.appendChild(card);
        }
    }
}

async function displayGoalCards(org) {
    const goalCardsContainer = document.getElementById('goalCards');
    goalCardsContainer.innerHTML = '';
    for (const goalId in org.goals) {
        const goal = await playerAction('getGoal', [goalId]);
        console.log('OROGOGOG', org)
        console.log('GOAOLALALOALALO', goal)
        const cycleSpecificOrgData = goal.orgData[org.id][org.currentCycle];
        if (goal) {
            const card = document.createElement('div');
            card.className = 'card goal-card';
            card.innerHTML = `
                <h3>Goal: ${goal.description || 'No description'}</h3>
                <p>ID: ${goalId}</p>
                <p>Created by: ${goal.createdById || 'Unknown'}</p>
                <p>Potential Value: ${cycleSpecificOrgData.potentialValue || 0}</p>
            `;
            goalCardsContainer.appendChild(card);
        }
    }
}


function updatePhaseActions(org, playerId, currentPhase) {
          // Hide all phase-specific divs
        const allPhaseDivs = document.querySelectorAll('#currentPhaseActions > div');
        allPhaseDivs.forEach(div => div.style.display = 'none');
            // Show the div for the current phase
        if(org.players.hasOwnProperty(playerId)) {
            const currentPhaseDiv = document.querySelector(`#currentPhaseActions .phase-${org.currentPhase}`);
        if (currentPhaseDiv) {
                currentPhaseDiv.style.display = 'block';
        }
}
}


function displayListItems(container, title, items) {
    container.append($('<h4>').text(title));
    const list = $('<ul>');
        if(items) {
            console.log('ITEMS:::::', items)
            Object.keys(items).forEach(item => {
        list.append($('<li>').text(item));
    });
        }
    container.append(list);
}

$(document).ready(async function() {

        $('#loginBtn').click(function() {
            apiKey = $('#apiKey').val();
            $.post('http://localhost:3000/login', { apiKey: apiKey }, function(data) {
                if (data.success) {
                    console.log(data.playerId)
                    playerId = data.playerId;
                    setMessage('Login successfully. playerID: ' + playerId);
                    $('#terminal').hide();
                    fetchOrgRegistry()
                } else {
                    showError('Login failed: ' + data.error);
                }
            });
        });

        $('#registerBtn').click(function() {
            const playerName = $('#playerName').val();
            $.post('http://localhost:3000/register', { playerName: playerName }, function(data) {
                if (data.success) {
                    playerId = data.playerId;
                    apiKey = data.apiKey;
                    setMessage('Registered successfully. API Key: ' + apiKey);
                    $('#terminal').hide();
                    fetchOrgRegistry()
                } else {
                    showError('Registration failed: ' + data.error);
                }
            });
        });

        $('#distributeSharesBtn').click(async function() {
            const playerIdShares = $('#playerIdShares').val();
            const shareAmountDistribute = $('#shareAmountDistribute').val();
            await playerAction('distributeShares', [playerId, playerIdShares, parseInt(shareAmountDistribute)]);
        });

        $('#proposeGoalBtn').click(async function() {
            const goalDescription = $('#goalDescription').val();
            const result = await playerAction('proposeGoalToOrg', [currentOrgId, goalDescription]);
            if (result) {
                // If the goal was successfully proposed, fetch the updated org data
                const updatedOrg = await playerAction('getOrg', [currentOrgId]);
                console.log('UPDATED', updatedOrg)
                displayGoalCards(updatedOrg);
            }
        });

        $('#allocateToGoalBtn').click(async function() {
            const amountAllocateGoal = $('#amountAllocateGoal').val();
            const goalIdAllocate = $('#goalIdAllocate').val();
            await playerAction('allocateToGoalFromOrg', [currentOrgId, parseInt(amountAllocateGoal), goalIdAllocate]);
        });

        $('#makeOfferBtn').click(async function() {
            const offerName = $('#offerName').val();
            const offerDescription = $('#offerDescription').val();
            const offerEffects = $('#offerEffects').val();
            const offerAsk = $('#offerAsk').val();
            const targetGoalIds = $('#targetGoalIds').val().split(',');
            await playerAction('offerToOrg', [currentOrgId, offerName, offerDescription, offerEffects, parseInt(offerAsk), targetGoalIds]);
        });

        $('#allocateToOfferBtn').click(async function() {
            const amountAllocateOffer = $('#amountAllocateOffer').val();
            const fromGoalId = $('#fromGoalId').val();
            const toOfferId = $('#toOfferId').val();
            await playerAction('allocateToOfferFromGoalInOrg', [currentOrgId, parseInt(amountAllocateOffer), fromGoalId, toOfferId]);
        });

        $('#acceptOfferBtn').click(async function() {
            const offerIdAccept = $('#offerIdAccept').val();
            await playerAction('acceptOffer', [playerId, offerIdAccept]);
        });

        $('#acceptCounterOfferBtn').click(async function() {
            const counterOfferId = $('#counterOfferId').val();
            const acceptCounterOfferDecision = $('#acceptCounterOfferDecision').val() === 'true';
            await playerAction('acceptCounterOffer', [currentOrgId, counterOfferId, acceptCounterOfferDecision]);
        });

        $('#claimCompletionBtn').click(async function() {
            const offerIdClaim = $('#offerIdClaim').val();
            const claimDescription = $('#claimDescription').val();
            await playerAction('claimCompletion', [currentOrgId, offerIdClaim, claimDescription]);
        });

        $('#challengeCompletionBtn').click(async function() {
            const completionIdChallenge = $('#completionIdChallenge').val();
            const challengeDescription = $('#challengeDescription').val();
            await playerAction('challengeCompletion', [currentOrgId, completionIdChallenge, challengeDescription]);
        });

        $('#supportChallengeBtn').click(async function() {
            const completionIdSupport = $('#completionIdSupport').val();
            const supportDecision = $('#supportDecision').val() === 'true';
            await playerAction('supportChallenge', [currentOrgId, completionIdSupport, supportDecision]);
        });

        $('#getLeaderboardBtn').click(function() {
            const leaderboardType = $('#leaderboardType').val();
            const leaderboardDimension = $('#leaderboardDimension').val();
            $.post('/player-action', {
                apiKey: apiKey,
                actionType: 'getLeaderboard',
                actionParams: [currentOrgId, leaderboardType, leaderboardDimension]
            }, function(data) {
                if (data.success) {
                    $('#leaderboardResult').html(JSON.stringify(JSOG.decode(data.result), null, 2));
                } else {
                    showError('Failed to get leaderboard: ' + data.error);
                }
            });
        });

        // Initialize visibility
        updateVisibility();
});

    </script>
</body>
</html>